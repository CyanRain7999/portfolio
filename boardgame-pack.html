<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å¡åŒ…è¯¦æƒ… | æœˆä¹‹æ£®çš„é»„ç“œæ¶</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <canvas id="bg-canvas"></canvas>

  <div class="shell">
    <header class="site-header">
      <div class="container header-inner">
        <a href="index.html" class="logo">æœˆã®æ£®<span>ğŸ¥’</span></a>
        <nav class="nav-links">
          <a href="boardgame.html" class="nav-link">è¿”å›å¡åŒ…åˆ—è¡¨</a>
          <a href="index.html" class="nav-link">èµ„æ–™é¦†é¦–é¡µ</a>
        </nav>
      </div>
    </header>

    <main class="container" id="pack-page-root">
      <!-- JS å¡«å……å†…å®¹ -->
    </main>

    <footer class="site-footer">
      <div class="container">
        Â© 2025 æœˆä¹‹æ£®çš„é»„ç“œæ¶ Â· Board Game
      </div>
    </footer>
  </div>

<script src="boardgame-data.js"></script>
<script src="portfolio-particles.js"></script>
<script>
  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  // æ ¹æ® tags ä¸­çš„ lv1/lv2/lv3 + type æ¨å¯¼ CSS class
  function getCardClasses(card) {
    const tags = (card.tags || []).map((t) =>
      String(t || "").toLowerCase()
    );
    const type = String(card.type || "").toLowerCase();

    let levelClass = "";
    if (tags.includes("lv1")) levelClass = " card-lv1";
    else if (tags.includes("lv2")) levelClass = " card-lv2";
    else if (tags.includes("lv3")) levelClass = " card-lv3";

    let typeClass = "";
    if (type.includes("æ”¿ç­–")) {
      typeClass = " card-type-policy";
    } else if (type.includes("è£…") || type.includes("è£…å¤‡")) {
      typeClass = " card-type-attach";
    } else if (type.includes("å•ä½")) {
      if (type.includes("æ ¸å¿ƒ")) {
        typeClass = " card-type-unit-core";
      } else if (type.includes("é›‡ä½£")) {
        typeClass = " card-type-unit-merc";
      } else {
        typeClass = " card-type-unit";
      }
    }

    return `card-item${levelClass}${typeClass}`;
  }

  // åŠ¨æ€åŠ è½½ data/cards-<packId>.js
  function loadPackCards(packId, onSuccess, onError) {
    const script = document.createElement("script");
    script.src = `data/cards-${encodeURIComponent(packId)}.js`;
    script.async = true;

    script.onload = function () {
      const cards = window.CARD_PACK_CARDS;
      if (Array.isArray(cards)) {
        onSuccess(cards);
      } else {
        onError &&
          onError(new Error("CARD_PACK_CARDS æœªå®šä¹‰æˆ–ä¸æ˜¯æ•°ç»„ã€‚"));
      }
      // ç”¨å®Œå¯ä»¥æ¸…æ‰ï¼Œé¿å…æ±¡æŸ“ï¼ˆå…¶å®è¿™ä¸€é¡µä¸ä¼šé‡å¤ç”¨ï¼‰
      // delete window.CARD_PACK_CARDS;
    };

    script.onerror = function () {
      onError &&
        onError(
          new Error(
            `æ— æ³•åŠ è½½ data/cards-${packId}.jsï¼Œè¯·ç¡®è®¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚`
          )
        );
    };

    document.head.appendChild(script);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const packId = getQueryParam("id");
    const root = document.getElementById("pack-page-root");

    if (!packId || !window.CARD_GAME) {
      root.innerHTML = `
        <section class="boardgame-pack-hero">
          <h1 class="hero-title">æœªæ‰¾åˆ°å¡åŒ…</h1>
          <p class="hero-subtitle">
            é“¾æ¥ä¼¼ä¹ç¼ºå°‘å‚æ•°ï¼Œæˆ–è€…è¯¥å¡åŒ…å°šæœªæ”¶å½•ã€‚
          </p>
          <p>
            <a href="boardgame.html" class="btn btn-primary btn-compact">è¿”å›å¡åŒ…åˆ—è¡¨</a>
          </p>
        </section>
      `;
      return;
    }

    const pack = CARD_GAME.packs.find((p) => p.id === packId);

    if (!pack) {
      root.innerHTML = `
        <section class="boardgame-pack-hero">
          <h1 class="hero-title">æœªæ‰¾åˆ°å¡åŒ…</h1>
          <p class="hero-subtitle">
            æ²¡æœ‰æ‰¾åˆ° ID ä¸º <code>${packId}</code> çš„å¡åŒ…ï¼Œè¯·ç¡®è®¤é“¾æ¥æˆ–æ•°æ®æ–‡ä»¶ã€‚
          </p>
          <p>
            <a href="boardgame.html" class="btn btn-primary btn-compact">è¿”å›å¡åŒ…åˆ—è¡¨</a>
          </p>
        </section>
      `;
      return;
    }

    const badgeText =
      pack.status === "released"
        ? "å·²æ”¶å½•"
        : pack.status === "wip"
        ? "æ•´ç†ä¸­"
        : pack.status === "planned"
        ? "è®¡åˆ’ä¸­"
        : "é¢„ç•™ç©ºä½";

    const heroHTML = `
      <section class="boardgame-pack-hero">
        <p class="eyebrow">Card Pack Detail</p>
        <h1 class="hero-title">${pack.name}</h1>
        <p class="boardgame-pack-meta">
          <span class="pack-badge">${badgeText}</span>
          ${
            pack.subtitle
              ? `<span class="dot-sep">Â·</span><span>${pack.subtitle}</span>`
              : ""
          }
        </p>
        <p class="hero-subtitle">
          ${pack.description || ""}
        </p>
        ${
          pack.era || pack.side
            ? `<p class="boardgame-pack-meta">
                ${pack.side ? `<span>${pack.side}</span>` : ""}
                ${
                  pack.era
                    ? `<span class="dot-sep">Â·</span><span>${pack.era}</span>`
                    : ""
                }
              </p>`
            : ""
        }
        ${
          pack.note
            ? `<p class="boardgame-pack-note">${pack.note}</p>`
            : ""
        }
      </section>
    `;

    const backHTML = `
      <section class="card-list-section">
        <p>
          <a href="boardgame.html" class="btn btn-ghost btn-compact">
            â† è¿”å›å¡åŒ…æ€»è§ˆ
          </a>
        </p>
      </section>
    `;

    // å…ˆç”»å‡ºå¤´éƒ¨ + å ä½çš„â€œæ­£åœ¨è½½å…¥â€åŒºåŸŸ
    root.innerHTML =
      heroHTML +
      `
      <section class="card-list-section">
        <h2 class="section-title">å•å¡åˆ—è¡¨</h2>
        <div id="cards-container">
          <p class="section-subtitle">
            æ­£åœ¨è½½å…¥å•å¡æ•°æ®â€¦â€¦
          </p>
        </div>
      </section>
    ` +
      backHTML;

    const cardsContainer = document.getElementById("cards-container");

    // å†å»åŠ¨æ€åŠ è½½ data/cards-<packId>.js
    loadPackCards(
      packId,
      function (cards) {
        if (!cards || !cards.length) {
          cardsContainer.innerHTML = `
            <p class="section-subtitle">
              è¿™ä¸ªå¡åŒ…çš„å…·ä½“å•å¡æ¡ç›®è¿˜åœ¨æ•´ç†ä¸­ã€‚
              <br />
              å¯ä»¥ç¨ååœ¨ <code>data/cards-${packId}.js</code> ä¸­è¡¥ä¸Š Excel å¯¼å‡ºçš„æ•°æ®ã€‚
            </p>
          `;
          return;
        }

        const cardItemsHTML = cards
          .map((card) => {
            const cardClass = getCardClasses(card);
            const tagStr = (card.tags || []).join(" Â· ");

            const countPart = card.count
              ? `<span class="dot-sep">Â·</span><span>æ•°é‡ ${card.count}</span>`
              : "";

            const statsStr = (card.stats || "").trim();
            const statsPart =
              statsStr && statsStr !== "0"
                ? `<span class="dot-sep">Â·</span><span>${statsStr}</span>`
                : "";

            return `
              <article class="${cardClass}">
                <header class="card-item-header">
                  ${
                    card.code
                      ? `<div class="card-item-code">${card.code}</div>`
                      : ""
                  }
                  <h3 class="card-item-name">${
                    card.name || "æœªå‘½åå¡ç‰Œ"
                  }</h3>
                </header>
                <p class="card-item-meta">
                  <span>${card.type || "ç±»å‹æœªæ ‡æ³¨"}</span>
                  ${countPart}
                  ${statsPart}
                  ${
                    card.role
                      ? `<span class="dot-sep">Â·</span><span>${card.role}</span>`
                      : ""
                  }
                </p>
                ${
                  tagStr
                    ? `<p class="card-item-tags">${tagStr}</p>`
                    : ""
                }
                ${
                  card.text
                    ? `<p class="card-item-text">${card.text}</p>`
                    : ""
                }
              </article>
            `;
          })
          .join("");

        cardsContainer.innerHTML = `
          <div class="card-list-grid">
            ${cardItemsHTML}
          </div>
        `;
      },
      function (err) {
        console.error(err);
        cardsContainer.innerHTML = `
          <p class="section-subtitle">
            æœªæ‰¾åˆ°è¯¥å¡åŒ…çš„å•å¡æ•°æ®æ–‡ä»¶ï¼š
            <br />
            <code>data/cards-${packId}.js</code>
            <br />
            å¯ä»¥ç¨åæ–°å»ºè¿™ä¸ªæ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­å®šä¹‰ <code>window.CARD_PACK_CARDS = [ ... ]</code>ã€‚
          </p>
        `;
      }
    );
  });
</script>
